<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>رمزنگاری DES | پروژه علی‌اکبر جوانمرد</title>
<link href="https://cdn.fontcdn.ir/Font/Persian/Vazir/Vazir.css" rel="stylesheet">
<style>
body{font-family:"Vazir",sans-serif;background:#f7f9fb;margin:0;direction:rtl}
.container{max-width:720px;margin:3rem auto;background:#fff;padding:2rem;border-radius:14px;box-shadow:0 3px 16px rgba(0,0,0,.12)}
h1{text-align:center;color:#007f9b;margin-bottom:1.5rem}
label{font-weight:bold;display:block;margin-top:1.1rem;margin-bottom:.3rem}
input,textarea,select{width:100%;padding:.6rem;border:1px solid #ccc;border-radius:6px;font-size:.95rem;transition:.25s}
input.invalid,textarea.invalid,select.invalid{border-color:#e74c3c;background:#fdecea}
.hint{font-size:0.83rem;color:#777;margin-top:3px}
.error-text{font-size:0.83rem;color:#e74c3c;margin-top:4px;display:none}
button{border:none;padding:.6rem 1rem;border-radius:8px;color:#fff;font-size:.95rem;cursor:pointer}
.btn-encrypt{background:#007f9b}.btn-decrypt{background:#a372f3}
.btn-encrypt:hover,.btn-decrypt:hover{opacity:.9}
button#copyOutput{background:#21a179}
button#copyOutput:hover{background:#1a8c68}
footer{text-align:center;color:#777;margin-top:2rem;font-size:0.83rem}
@media(max-width:620px){.container{margin:1rem;padding:1.3rem}}
#iv{text-align:left;direction:ltr;}
</style>
</head>

<body>
<div class="container">
  <h1>💠 رمزنگاری پیام به روش DES</h1>
  <form id="cryptoForm" action="/process" method="POST" novalidate>

    <!-- Plaintext -->
    <label for="plaintext">📝 متن ورودی (Plaintext)</label>
    <textarea id="plaintext" name="plaintext" required>{{ plaintext }}</textarea>
    <div class="hint" id="hint-plaintext">فقط از حروف انگلیسی، اعداد و علائم مجاز استفاده کنید.</div>
    <div class="error-text" id="error-plaintext"></div>

    <!-- Block size -->
    <label for="block_size">📦 اندازه بلوک (Block Size)</label>
    <select id="block_size" name="block_size">
      <option value="8"  {{ 'selected' if block_size==8  }}>8</option>
      <option value="16" {{ 'selected' if block_size==16 }}>16</option>
      <option value="32" {{ 'selected' if block_size==32 }}>32</option>
      <option value="64" {{ 'selected' if block_size==64 }}>64</option>
      <option value="128"{{ 'selected' if block_size==128 }}>128</option>
    </select>
    <div class="hint" id="hint-block">طول بلوک باید عددی زوج و متناسب با متن باشد.</div>
    <div class="error-text" id="error-block"></div>

    <!-- Key -->
    <label for="key">🔒 کلید DES (Key)</label>
    <input 
      type="text" id="key" name="key"
      value="{{ key }}"
      required
      maxlength="7"
      pattern=".{1,7}"
      title="طول کلید باید بین ۱ تا ۷ کاراکتر (حداکثر ۵۶ بیت) باشد."
      placeholder="کلید را وارد کنید (۱ تا ۷ کاراکتر)"
    />
    <div class="hint" id="key-hint">کلید می‌تواند از ۱ تا ۷ کاراکتر باشد (DES = ۵۶ بیت مؤثر).</div>
    <div class="error-text" id="error-key"></div>

    <!-- IV -->
    <label for="iv">🔹 بردار اولیه (IV)</label>
    <input type="text" id="iv" name="iv" value="{{ iv }}" required placeholder="مثلاً 12345678" />
    <div class="hint" id="hint-iv">
      در حالت‌های CBC / CFB / OFB لازم است. طول IV باید برابر با (Block Size ÷ 8) باشد.
    </div>
    <div class="error-text" id="error-iv"></div>

    <!-- Mode -->
    <label for="mode">🧩 حالت اجرا (Mode)</label>
    <select id="mode" name="mode">
      <option value="ECB" {{ 'selected' if mode=='ECB' }}>ECB</option>
      <option value="CBC" {{ 'selected' if mode=='CBC' }}>CBC</option>
      <option value="CFB" {{ 'selected' if mode=='CFB' }}>CFB</option>
      <option value="OFB" {{ 'selected' if mode=='OFB' }}>OFB</option>
      <option value="CTR" {{ 'selected' if mode=='CTR' }}>CTR</option>
    </select>
    <div class="hint" id="mode-hint">
      نوع مد رمزگذاری را انتخاب کنید.  
      در حالت <b>CTR</b> از شمارنده به‌جای IV استفاده می‌شود و طول آن باید مثل IV باشد.
    </div>

    <!-- Rounds -->
    <label for="rounds">🔁 تعداد دورها (Rounds)</label>
    <input type="number" id="rounds" name="rounds" value="{{ rounds }}" min="8" max="32" required />
    <div class="hint" id="hint-rounds">عدد بین ۸ تا ۳۲ (معمولاً ۱۶ برای DES استاندارد).</div>
    <div class="error-text" id="error-rounds"></div>

    <!-- Buttons -->
    <div style="display:flex;gap:1rem;margin-top:1.3rem;flex-wrap:wrap">
      <button type="button" class="btn-encrypt" onclick="submitForm('encrypt')">رمزنگاری</button>
      <button type="button" class="btn-decrypt" onclick="submitForm('decrypt')">رمزگشایی</button>
    </div>

    <!-- Result -->
    <label for="result" style="margin-top:1rem">نتیجه:</label>
    <div style="display:flex;gap:.5rem;align-items:center;flex-wrap:wrap">
      <textarea id="result" readonly rows="4" style="flex:1">{{ result }}</textarea>
      <button type="button" id="copyOutput">📋 کپی</button>
    </div>
    <div id="copyMessage" class="hint" style="color:#21a179;margin-top:.4rem;"></div>
  </form>
  <footer>© علی‌اکبر جوانمرد – پروژه امنیت شبکه</footer>
</div>

<script>
const asciiRegex=/^[\x20-\x7E]*$/;
const form=document.getElementById('cryptoForm');
const fields={
  plaintext:document.getElementById('plaintext'),
  key:document.getElementById('key'),
  iv:document.getElementById('iv'),
  rounds:document.getElementById('rounds'),
  block:document.getElementById('block_size'),
  mode:document.getElementById('mode')
};

// جلوگیری از ورود حروف فارسی
['plaintext','key','iv'].forEach(id=>{
  const el=fields[id];
  el.addEventListener('keypress',e=>{if(!asciiRegex.test(e.key)) e.preventDefault();});
  el.addEventListener('paste',e=>{
    const pasted=(e.clipboardData||window.clipboardData).getData('text');
    if(!asciiRegex.test(pasted)) e.preventDefault();
  });
});

// محدودیت طول کلید بین ۱ تا ۷
fields.key.addEventListener('input',()=>{
  const val=fields.key.value;
  if(val.length>7){fields.key.value=val.slice(0,7);}
});

// پیشنهاد اندازه بلوک
fields.plaintext.addEventListener('input',()=>{
  const len=fields.plaintext.value.length;
  const hint=document.getElementById('hint-block');
  if(len>0){
    let nearest=[8,16,32,64,128].find(v=>v>=len*8)||128;
    hint.innerText=`طول متن ${len} کاراکتر است → پیشنهاد بلوک ${nearest}.`;
  } else hint.innerText="طول بلوک باید عددی زوج و متناسب با متن باشد.";
});

function submitForm(operation){
  if(fields.key.value.length<1||fields.key.value.length>7){
    alert("❌ طول کلید باید بین ۱ تا ۷ کاراکتر باشد (حداکثر ۵۶ بیت).");
    fields.key.focus();
    return;
  }
  const opInput=document.createElement('input');
  opInput.type='hidden';opInput.name='operation';opInput.value=operation;
  form.appendChild(opInput);
  form.submit();
}

document.getElementById('copyOutput').addEventListener('click',async()=>{
  await navigator.clipboard.writeText(document.getElementById('result').value);
  const msg=document.getElementById('copyMessage');
  msg.innerText="✅ نتیجه کپی شد!";
  setTimeout(()=>msg.innerText="",3000);
});
</script>
</body>
</html>
