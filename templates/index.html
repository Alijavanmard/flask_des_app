<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>رمزنگاری DES | پروژه علی‌اکبر جوانمرد</title>
<link href="https://cdn.fontcdn.ir/Font/Persian/Vazir/Vazir.css" rel="stylesheet">
<style>
body{font-family:"Vazir",sans-serif;background:#f7f9fb;margin:0;direction:rtl}
.container{max-width:720px;margin:3rem auto;background:#fff;padding:2rem;border-radius:14px;box-shadow:0 3px 16px rgba(0,0,0,.12)}
h1{text-align:center;color:#007f9b;margin-bottom:1.5rem}
label{font-weight:bold;display:block;margin-top:1.1rem;margin-bottom:.3rem}
input,textarea,select{width:100%;padding:.6rem;border:1px solid #ccc;border-radius:6px;font-size:.95rem;transition:.25s}
input.invalid,textarea.invalid,select.invalid{border-color:#e74c3c;background:#fdecea}
.hint{font-size:0.83rem;color:#777;margin-top:3px}
.error-text{font-size:0.83rem;color:#e74c3c;margin-top:4px;display:none}
button{border:none;padding:.6rem 1rem;border-radius:8px;color:#fff;font-size:.95rem;cursor:pointer}
.btn-encrypt{background:#007f9b}.btn-decrypt{background:#a372f3}
.btn-encrypt:hover,.btn-decrypt:hover{opacity:.9}
button#copyOutput{background:#21a179}
button#copyOutput:hover{background:#1a8c68}
footer{text-align:center;color:#777;margin-top:2rem;font-size:0.83rem}
@media(max-width:620px){.container{margin:1rem;padding:1.3rem}}
#iv{text-align:left;direction:ltr;} /* IV چپ‌به‌راست */
</style>
</head>

<body>
<div class="container">
  <h1>💠 رمزنگاری پیام به روش DES</h1>
  <form id="cryptoForm" action="/process" method="POST" novalidate>

    <!-- Plaintext -->
    <label for="plaintext">📝 متن ورودی (Plaintext)</label>
    <textarea id="plaintext" name="plaintext" required>{{ plaintext }}</textarea>
    <div class="hint" id="hint-plaintext">فقط از حروف انگلیسی، اعداد و علائم مجاز استفاده کنید.</div>
    <div class="error-text" id="error-plaintext"></div>

    <!-- Block size -->
    <label for="block_size">📦 اندازه بلوک (Block Size)</label>
    <select id="block_size" name="block_size">
      <option value="8"  {{ 'selected' if block_size==8  }}>8</option>
      <option value="16" {{ 'selected' if block_size==16 }}>16</option>
      <option value="32" {{ 'selected' if block_size==32 }}>32</option>
      <option value="64" {{ 'selected' if block_size==64 }}>64</option>
      <option value="128"{{ 'selected' if block_size==128 }}>128</option>
    </select>
    <div class="hint" id="hint-block">طول بلوک باید عددی زوج و متناسب با متن باشد.</div>
    <div class="error-text" id="error-block"></div>

    <!-- Key length -->
    <label for="key_length">🔑 طول کلید (Key Length)</label>
    <select id="key_length" name="key_length">
      <option value="8"   {{ 'selected' if key_length==8 }}>8</option>
      <option value="16"  {{ 'selected' if key_length==16 }}>16</option>
      <option value="32"  {{ 'selected' if key_length==32 }}>32</option>
      <option value="64"  {{ 'selected' if key_length==64 }}>64</option>
      <option value="128" {{ 'selected' if key_length==128 }}>128</option>
    </select>
    <div class="hint" id="hint-keylen">هر ۸ بیت = ۱ کاراکتر، مثلاً برای ۶۴ بیت باید ۸ کاراکتر باشد.</div>
    <div class="error-text" id="error-keylen"></div>

    <!-- Key -->
    <label for="key">🔒 مقدار کلید (Key)</label>
    <input type="text" id="key" name="key" value="{{ key }}" required />
    <div class="hint" id="key-hint">کلید باید متناسب با طول کلید انتخاب‌شده باشد.</div>
    <div class="error-text" id="error-key"></div>

    <!-- IV -->
    <label for="iv">🔹 بردار اولیه (IV)</label>
    <input type="text" id="iv" name="iv" value="{{ iv }}" required placeholder="مثلاً 12345678" />
    <div class="hint" id="hint-iv">
      در حالت‌های CBC / CFB / OFB لازم است. طول IV باید برابر با (Block Size ÷ 8) باشد.
    </div>
    <div class="error-text" id="error-iv"></div>

    <!-- Mode -->
    <label for="mode">🧩 حالت اجرا (Mode)</label>
    <select id="mode" name="mode">
      <option value="ECB" {{ 'selected' if mode=='ECB' }}>ECB</option>
      <option value="CBC" {{ 'selected' if mode=='CBC' }}>CBC</option>
      <option value="CFB" {{ 'selected' if mode=='CFB' }}>CFB</option>
      <option value="OFB" {{ 'selected' if mode=='OFB' }}>OFB</option>
      <option value="CTR" {{ 'selected' if mode=='CTR' }}>CTR</option>
    </select>
    <div class="hint" id="mode-hint">
      نوع مد رمزگذاری را انتخاب کنید.  
      در حالت <b>CTR</b> از شمارنده به‌جای IV استفاده می‌شود و طول آن باید مثل IV باشد.
    </div>

    <!-- Rounds -->
    <label for="rounds">🔁 تعداد دورها (Rounds)</label>
    <input type="number" id="rounds" name="rounds" value="{{ rounds }}" min="8" max="32" required />
    <div class="hint" id="hint-rounds">عدد بین ۸ تا ۳۲ (معمولاً ۱۶ برای DES استاندارد).</div>
    <div class="error-text" id="error-rounds"></div>

    <!-- Buttons -->
    <div style="display:flex;gap:1rem;margin-top:1.3rem;flex-wrap:wrap">
      <button type="button" class="btn-encrypt" onclick="submitForm('encrypt')">رمزنگاری</button>
      <button type="button" class="btn-decrypt" onclick="submitForm('decrypt')">رمزگشایی</button>
    </div>

    <!-- Result -->
    <label for="result" style="margin-top:1rem">نتیجه:</label>
    <div style="display:flex;gap:.5rem;align-items:center;flex-wrap:wrap">
      <textarea id="result" readonly rows="4" style="flex:1">{{ result }}</textarea>
      <button type="button" id="copyOutput">📋 کپی</button>
    </div>
    <div id="copyMessage" class="hint" style="color:#21a179;margin-top:.4rem;"></div>
  </form>
  <footer>© علی‌اکبر جوانمرد – پروژه امنیت شبکه</footer>
</div>

<script>
const asciiRegex=/^[\x20-\x7E]*$/;
const form=document.getElementById('cryptoForm');
const fields={
  plaintext:document.getElementById('plaintext'),
  key:document.getElementById('key'),
  iv:document.getElementById('iv'),
  rounds:document.getElementById('rounds'),
  keyLength:document.getElementById('key_length'),
  block:document.getElementById('block_size'),
  mode:document.getElementById('mode')
};

// ✳️ جلوگیری از تایپ / چسباندن فارسی در تمام فیلدها
['plaintext','key','iv'].forEach(id=>{
  const el=fields[id];
  el.addEventListener('keypress',e=>{if(!asciiRegex.test(e.key)) e.preventDefault();});
  el.addEventListener('paste',e=>{
    const pasted=(e.clipboardData||window.clipboardData).getData('text');
    if(!asciiRegex.test(pasted)) e.preventDefault();
  });
});

// ✳️ پیشنهاد خودکار متناسب با طول متن و بلوک
fields.plaintext.addEventListener('input',()=>{
  const len=fields.plaintext.value.length;
  const hint=document.getElementById('hint-block');
  if(len>0){
    let nearest=[8,16,32,64,128].find(v=>v>=len*8) || 128;
    hint.innerText=`طول متن شما ${len} کاراکتر است. پیشنهاد می‌شود بلوک ${nearest} انتخاب شود.`;
  } else hint.innerText="طول بلوک باید عددی زوج و متناسب با متن باشد.";
});

// ✳️ پیشنهاد خودکار براساس طول کلید
fields.key.addEventListener('input',()=>{
  const bits=parseInt(fields.keyLength.value);
  const need=bits/8;
  const cur=fields.key.value.length;
  const hint=document.getElementById('hint-keylen');
  if(cur!==need){
    hint.innerText=`کلید فعلی ${cur} کاراکتر است اما باید ${need} کاراکتر باشد.`;
  } else {hint.innerText=`✅ طول کلید مناسب (${need} کاراکتر).`;}
});
// جلوگیری از ورود بیشتر از حد مجاز طول کلید
fields.key.addEventListener('input',()=>{
  const bits=parseInt(fields.keyLength.value);
  const need=bits/8;
  if(fields.key.value.length>need){
    fields.key.value=fields.key.value.substring(0,need);
  }
});

// ✳️ کنترل IV بر اساس mode
fields.mode.addEventListener('change',()=>{
  const mode=fields.mode.value;
  const hintIv=document.getElementById('hint-iv');
  const lblIv=document.querySelector('label[for="iv"]');
  if(mode==='ECB'){
    fields.iv.disabled=true;
    fields.iv.value='';
    lblIv.style.opacity='0.5';
    hintIv.innerText='در حالت ECB نیازی به IV وجود ندارد و ورود ممنوع است.';
  } else if(mode==='CTR'){
    fields.iv.disabled=false;
    lblIv.style.opacity='1';
    hintIv.innerHTML='در حالت CTR از شمارنده (Counter) استفاده می‌شود. طول آن باید برابر (Block Size ÷ 8) باشد.';
  } else {
    fields.iv.disabled=false;
    lblIv.style.opacity='1';
    hintIv.innerText='در حالت‌های CBC، CFB، OFB لازم است. طول IV باید برابر با (Block Size ÷ 8) باشد.';
  }
});

// ✳️ کنترل IV هنگام تایپ
fields.iv.addEventListener('input',()=>{
  const blockBits=parseInt(fields.block.value);
  const need=blockBits/8;
  const val=fields.iv.value;
  if(!asciiRegex.test(val)){
    setError('error-iv','IV فقط باید شامل حروف و اعداد انگلیسی باشد.');
  }else if(val.length!==need){
    setError('error-iv',`طول IV باید ${need} کاراکتر باشد (فعلی ${val.length}).`);
  } else clearError('error-iv');
});

// ✳️ کنترل محدوده rounds
fields.rounds.addEventListener('input',()=>{
  let val=parseInt(fields.rounds.value);
  const hint=document.getElementById('hint-rounds');
  if(val<8){fields.rounds.value=8; val=8;}
  if(val>32){fields.rounds.value=32; val=32;}
  hint.innerText=`تعداد دورها تنظیم شد روی ${val}. (بازهٔ مجاز ۸ تا ۳۲ است)`;
});

// توابع از قبل موجود:
function setError(id,msg){const el=document.getElementById(id);el.innerText=msg;el.style.display='block';}
function clearError(id){document.getElementById(id).style.display='none';}

function validateAsciiField(fld,errId,label){
  if(!asciiRegex.test(fld.value)){
    fld.classList.add('invalid');setError(errId,`${label} باید فقط انگلیسی باشد.`);return false;
  }fld.classList.remove('invalid');clearError(errId);return true;
}
function validateKeyLength(){
  const bits=parseInt(fields.keyLength.value);
  const need=bits/8;
  const cur=fields.key.value.length;
  if(cur!==need){setError('error-key',`طول کلید باید ${need} کاراکتر باشد (فعلی ${cur}).`);return false;}
  clearError('error-key');return true;
}
function validateIV(){
  const mode=fields.mode.value;
  if(mode==='ECB') return true;
  const blockBits=parseInt(fields.block.value);
  const need=blockBits/8;
  const val=fields.iv.value.trim();
  if(!asciiRegex.test(val)){setError('error-iv','IV فقط باید انگلیسی باشد.');return false;}
  if(val.length!==need){setError('error-iv',`طول IV باید ${need} کاراکتر باشد (فعلی ${val.length}).`);return false;}
  clearError('error-iv');return true;
}

// ✳️ معتبرسازی و ارسال نهایی
function submitForm(operation){
  const valid=
    validateAsciiField(fields.plaintext,'error-plaintext','متن') &&
    validateKeyLength() &&
    validateIV();
  if(!valid){alert('❌ لطفاً خطاها را برطرف کنید.');return;}
  const opInput=document.createElement('input');
  opInput.type='hidden';opInput.name='operation';opInput.value=operation;
  form.appendChild(opInput);form.submit();
}

// دکمه کپی نتیجه
document.getElementById('copyOutput').addEventListener('click',async()=>{
  await navigator.clipboard.writeText(document.getElementById('result').value);
  const msg=document.getElementById('copyMessage');
  msg.innerText="✅ نتیجه کپی شد!";setTimeout(()=>msg.innerText="",3000);
});
</script>
</body>
</html>
